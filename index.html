<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Altimeter</title>
    <style>
        /* --- COLOR THEMES --- */
        :root {
            /* Default Dark Mode */
            --bg-body: #000000;
            --bg-card: #121212;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent: #00e676;
            --variance-bg: #222222;
            --variance-text: #e0e0e0;
            --error: #ff5252;
            --btn-text: #000000;
            --shadow: rgba(0,0,0,0.5);
            --loc-bg: #1a1a1a;
        }

        /* Light Mode Overrides */
        body.light-mode {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #222222;
            --text-muted: #666666;
            --accent: #00c853;
            --variance-bg: #eeeeee;
            --variance-text: #333333;
            --btn-text: #ffffff;
            --shadow: rgba(0,0,0,0.1);
            --loc-bg: #f8f9fa;
        }

        html, body {
            height: 100%; /* Fix for mobile browser height issues */
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        /* --- THE 90% FLOATING CONTAINER --- */
        .app-container {
            width: 90%;       /* Width constraint */
            max-width: 400px; /* Max width for tablets/desktop */
            height: 90%;      /* Height constraint */
            max-height: 800px;
            
            background-color: var(--bg-card);
            border-radius: 30px;
            box-shadow: 0 10px 40px var(--shadow);
            
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* FIX: Distributes items nicely instead of pushing to bottom */
            align-items: center;
            text-align: center;
            
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            transition: background-color 0.3s;
        }

        /* --- HEADER & THEME TOGGLE --- */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 0 5px;
            box-sizing: border-box;
            /* No margin bottom, let space-evenly handle it */
        }

        h1 { 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin: 0;
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            font-size: 1.2rem;
            box-shadow: none;
            color: var(--text-muted);
        }

        /* --- DATA DASHBOARD --- */
        .dashboard {
            /* Removed flex-grow to stop it from pushing controls down */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .value-group { margin-bottom: 15px; }
        
        .value { 
            font-size: 5rem; 
            font-weight: 700; 
            line-height: 1; 
            letter-spacing: -2px;
            font-variant-numeric: tabular-nums;
        }
        
        .unit { 
            font-size: 1.5rem; 
            color: var(--accent); 
            font-weight: 600; 
            vertical-align: super;
        }

        .variance-box {
            font-size: 1rem;
            background-color: var(--variance-bg);
            color: var(--variance-text); 
            padding: 6px 18px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
            transition: opacity 0.3s, background-color 0.3s;
        }
        
        .sub-metric {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-top: 10px;
        }

        /* --- LOCATION BLOCK (Fixed Wrapping) --- */
        .location-block {
            margin-top: 25px;
            padding: 12px 15px;
            background-color: var(--loc-bg);
            border-radius: 15px;
            width: 100%;
            box-sizing: border-box;
            transition: opacity 0.5s;
        }
        
        .loc-city {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 5px;
            line-height: 1.3;
            /* FIX: Allow text wrap */
            white-space: normal; 
            word-wrap: break-word;
        }
        
        .loc-coords {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace; 
        }

        /* --- CONTROLS --- */
        .controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .btn-main { 
            background-color: var(--accent); 
            color: var(--btn-text); 
            border: none; 
            padding: 16px 50px; 
            font-size: 1.1rem; 
            font-weight: 700; 
            border-radius: 50px; 
            cursor: pointer; 
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.96); }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-muted);
            border-radius: 50%;
            opacity: 0.5;
        }
        .dot.ping {
            background-color: var(--accent);
            opacity: 1;
            box-shadow: 0 0 15px var(--accent);
            animation: radar-ping 0.8s ease-out;
        }
        @keyframes radar-ping {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        .hidden { display: none !important; }
        .invisible { opacity: 0; }
        .text-error { color: var(--error) !important; }
        .stale { opacity: 0.3; filter: blur(2px); transition: all 0.5s; }
        
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Altimeter</h1>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è</button>
        </header>

        <div class="dashboard">
            <div id="start-msg" style="color: var(--text-muted); max-width: 250px; line-height: 1.5;">
                Tap start to begin
            </div>

            <div id="live-data" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div class="value-group">
                    <span class="value" id="alt-meters">0</span>
                    <span class="unit">m</span>
                </div>
                
                <div id="variance-box" class="variance-box">
                    ¬± <span id="accuracy">--</span>m
                </div>

                <div class="sub-metric">
                    <span id="alt-feet">0</span> ft
                </div>

                <div class="location-block">
                    <div id="loc-city" class="loc-city">Locating...</div>
                    <div id="loc-coords" class="loc-coords">--¬∞N, --¬∞E</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="btn-start" class="btn-main" onclick="startTracking()">START</button>
            
            <div class="status-bar">
                <div id="pulse-dot" class="dot hidden"></div>
                <span id="status-text">Ready</span>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                // Check for updates every time page opens
                reg.update();
    });

    // If a new service worker takes over, reload the page automatically
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
    });
 }
        
        // --- THEME SWITCHER ---
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('theme-btn');
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                btn.textContent = "üåô";
                document.querySelector('meta[name="theme-color"]').setAttribute("content", "#f0f2f5");
            } else {
                btn.textContent = "‚òÄÔ∏è";
                document.querySelector('meta[name="theme-color"]').setAttribute("content", "#000000");
            }
        }

        // --- ALTIMETER LOGIC ---
        let emaAltitude = null;
        const ALPHA = 0.2; 
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 1500; 
        let signalWatchdog = null;    

        // --- LOCATION LOGIC ---
        let lastCityFetch = 0;
        const CITY_FETCH_INTERVAL = 120000;

        function startTracking() {
            const btnStart = document.getElementById('btn-start');
            const startMsg = document.getElementById('start-msg');
            const liveData = document.getElementById('live-data');
            const statusText = document.getElementById('status-text');
            const pulseDot = document.getElementById('pulse-dot');
            const varianceBox = document.getElementById('variance-box');
            
            const locCity = document.getElementById('loc-city');
            const locCoords = document.getElementById('loc-coords');

            if (!navigator.geolocation) {
                statusText.textContent = "GPS Not Supported";
                statusText.classList.add('text-error');
                return;
            }

            btnStart.classList.add('hidden');
            startMsg.classList.add('hidden');
            liveData.classList.remove('hidden');
            pulseDot.classList.remove('hidden');
            statusText.textContent = "Acquiring Signal...";

            const triggerSignalLoss = () => {
                statusText.textContent = "NO SIGNAL";
                statusText.classList.add('text-error');
                statusText.style.color = ""; 
                pulseDot.classList.remove('ping');
                liveData.classList.add('stale');
                varianceBox.classList.add('invisible');
            };

            signalWatchdog = setTimeout(triggerSignalLoss, 10000);

            navigator.geolocation.watchPosition(
                (pos) => {
                    const rawAlt = pos.coords.altitude;
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    const currentTime = Date.now();

                    // --- LOCATION HANDLER ---
                    locCoords.textContent = `${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞`;
                    if (currentTime - lastCityFetch > CITY_FETCH_INTERVAL) {
                        fetchCityName(lat, lon);
                        lastCityFetch = currentTime;
                    }

                    // --- ALTIMETER HANDLER ---
                    let accuracy = pos.coords.altitudeAccuracy;
                    if (!accuracy || accuracy === null) {
                        accuracy = pos.coords.accuracy; 
                    }

                    clearTimeout(signalWatchdog);
                    signalWatchdog = setTimeout(triggerSignalLoss, 10000);
                    
                    statusText.classList.remove('text-error');
                    liveData.classList.remove('stale');
                    varianceBox.classList.remove('invisible');

                    if (rawAlt !== null) {
                        if (emaAltitude === null) emaAltitude = rawAlt;
                        else emaAltitude = (rawAlt * ALPHA) + (emaAltitude * (1 - ALPHA));
                    }

                    if (currentTime - lastUpdateTime > UPDATE_INTERVAL) {
                        pulseDot.classList.remove('ping');
                        void pulseDot.offsetWidth; 
                        pulseDot.classList.add('ping');

                        statusText.style.color = "var(--accent)";
                        statusText.textContent = "SIGNAL ACTIVE";

                        if (emaAltitude !== null) {
                            document.getElementById('alt-meters').textContent = Math.round(emaAltitude);
                            document.getElementById('alt-feet').textContent = Math.round(emaAltitude * 3.28084);
                        }
                        
                        if (accuracy) {
                             document.getElementById('accuracy').textContent = Math.round(accuracy);
                        } else {
                             document.getElementById('accuracy').textContent = "~";
                        }
                        
                        lastUpdateTime = currentTime;
                    }
                }, 
                (err) => {
                    statusText.textContent = "GPS ERROR";
                    statusText.classList.add('text-error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function fetchCityName(lat, lon) {
            const locCity = document.getElementById('loc-city');
            const apiURL = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`;

            fetch(apiURL)
                .then(response => response.json())
                .then(data => {
                    const city = data.city || data.locality || data.principalSubdivision;
                    const country = data.countryCode;
                    
                    if (city && country) {
                        locCity.textContent = `${city}, ${country}`;
                    } else if (data.countryName) {
                        locCity.textContent = data.countryName;
                    } else {
                        locCity.textContent = "Unknown Location";
                    }
                })
                .catch(err => console.log(err));
        }
    </script>
</body>
</html>
